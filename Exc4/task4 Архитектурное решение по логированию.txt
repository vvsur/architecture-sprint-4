### Планирование логирования как часть решения "Наблюдаемости"

#### **Мотивация**

Логирование является фундаментом для анализа системы и выявления проблем, особенно в рамках концепции "Наблюдаемости". В отличие от мониторинга, который предоставляет общую картину в реальном времени, логи позволяют детально разобраться в причинах сбоев. 

1. **Выявление проблем:** Логирование помогает понять, что произошло, когда и при каких обстоятельствах. Это особенно важно для поиска редких и сложных ошибок.
2. **Устранение потерь:** Ситуации с потерей заказов могли быть решены быстрее, если бы в системе существовало подробное логирование бизнес-процессов и технических операций.
3. **Гибкость:** Логирование JSON в Elasticsearch позволяет быстро визуализировать данные в Kibana, что облегчает поиск ошибок и узких мест.
4. **Экономия ресурсов:** Количество логов можно сократить благодаря интеграции с мониторингом и трейсингом, сохранив только критически важные данные.

---

### Анализ системы и C4-диаграмма

На основе C4-диаграммы компании логирование будет сосредоточено на ключевых подсистемах:

1. **Интернет-магазин:**
   - Логирование в минимальном объеме. Веб-приложение и PostgreSQL оставляем на штатных логах. Разбор ошибок возможен вручную при необходимости.
   
2. **CRM:**
   - Трейсинг начинается с момента создания заказа. Логи фиксируют уникальный номер заказа, изменения и передачу в MES.

3. **MES и его API:**
   - Основное внимание уделяется MES как наиболее загруженной системе. Логирование JSON в Elasticsearch, разбор в Kibana. Мониторинг состояния базы данных осуществляется отдельно.

4. **RabbitMQ:**
   - Трейсинг сообщений через очереди, фиксируем критически важные операции.

---

### Список логов с уровнями логирования

#### **INFO** — штатное поведение:
- **Бизнесовые логи (по заказу):**
  - Заказ создан (указываем систему-источник, пользователя системы).
  - Заказ изменен (оператор CRM).
  - Заказ передан (CRM → MES).
  - Заказ получен (MES).
  - Заказ выбран оператором (MES).
  - Заказ в работе (MES).
  - Заказ выполнен (MES).
  - Заказ отправлен (MES).
  - Заказ закрыт (CRM).

- **Пользовательские действия:**
  - Вход в систему.
  - Создание, изменение, удаление объектов (например, заказов).
  - Запуск отчетов.
  - Переходы между интерфейсами (опционально).

- **Системные процессы:**
  - Логирование всех стадий автоматизированных процессов. Например, процесс выбора заказа оператором: назначение исполнителя, изменение статуса, установка даты исполнения.

#### **ERROR** — ошибки выполнения:
- Ошибки бизнес-логики, которые приводят к остановке процессов.
- Ошибки интеграции (например, сбой передачи заказа из CRM в MES).

#### **FATAL** — критические сбои:
- Полная остановка работы системы.
- Ошибки баз данных или API, влияющие на доступность системы.

#### **WARN** — необязательно, фиксируем потенциально проблемные ситуации:
- Повышение нагрузки на API.
- Потенциальные конфликты данных.

---

### Предлагаемое решение

Для реализации логирования предлагается использовать стек ELK:

1. **Logstash:**
   - Сбор логов из всех систем и их перенос в Elasticsearch.
   - Форматирование логов в JSON для упрощения поиска и анализа.

2. **Elasticsearch:**
   - Хранение и индексация логов.
   - Поддержка поиска по любым параметрам, включая уникальный идентификатор заказа.

3. **Kibana:**
   - Визуализация логов для анализа данных.
   - Настройка дашбордов для быстрого доступа к ключевым метрикам.

#### Минимальный набор:
- Полное логирование для MES, включая API.
- Логирование критически важных операций в CRM.
- Мониторинг состояния базы данных MES, логи PostgreSQL анализируются только при ошибках.

---

### Политика безопасности логов

1. **Ограничение доступа:**
   - Доступ к ELK предоставляется только сервисной службе, администраторам и специалистам ИБ.
   
2. **Аутентификация и авторизация:**
   - Использование X-Pack для интеграции с Active Directory/LDAP.
   - Подключение через SSO (например, Keycloak). 

3. **Регламенты доступа:**
   - Для ручного создания учетных записей потребуется согласование с ИБ, что может замедлить процесс. Поэтому рекомендуется использовать централизованные системы аутентификации.

---

### Политика хранения логов

1. **Бизнесовые данные:**
   - Минимальный срок хранения логов с персональными данными — 3 года (в зависимости от политики компании).
   
2. **Технические данные (MES):**
   - Без персональных данных минимальный срок хранения — 6 месяцев.

3. **Отдельный индекс для каждой системы:**
   - Позволяет легко масштабировать и управлять логами по мере подключения новых систем.

---

### Превращение системы логирования в систему анализа

Для улучшения аналитических возможностей логов:

1. **Сетевой мониторинг и оповещения:**
   - Использование Elasticsearch и Kibana для настройки алертов по API.
   - Анализ сетевого трафика в реальном времени для быстрого реагирования на угрозы.

2. **Автоматизация:**
   - Настройка автоматического анализа ошибок и предупреждений.
   - Генерация отчетов по критически важным метрикам.

3. **Интеграция с мониторингом и трейсингом:**
   - Использование логов как дополнения к мониторингу и трейсингу для создания единой системы наблюдаемости.

---

### Приоритеты внедрения

1. **MES и API:**
   - Самая загруженная часть системы, где вероятность ошибок наиболее высока.
2. **CRM:**
   - Логирование критически важных операций с заказами.
3. **Интернет-магазин:**
   - Реализация после настройки более приоритетных систем.

---

Логирование как часть системы наблюдаемости позволит компании не только быстрее находить и исправлять ошибки, но и повысить общую стабильность системы за счет точной диагностики проблем.